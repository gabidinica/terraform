# Demo Project: Automate AWS Infrastructure

## Technologies Used
- Terraform
- AWS
- Docker
- Linux
- Git

## Project Description
Create a Terraform project to automate provisioning AWS infrastructure and its components, such as:  
- VPC  
- Subnet  
- Route Table  
- Internet Gateway  
- EC2  
- Security Group  

Configure Terraform scripts to automate deploying a Docker container to an EC2 instance.

---

**Note:** You’ll need to add your own `terraform.tfvars` file and provide values for the variables.

---

### VPC & Subnet
The VPC and subnet have been renamed for the application so they can be independent of the environment.  
In AWS, there will still be the default VPC and its three default subnets, and in addition, we will create new subnets as needed.

### Route Table & Internet Gateway
The route table is automatically generated by AWS for our new VPC and acts like a virtual router inside the VPC.  
Network ACLs act as firewall configurations for the subnets.

The commented code in Terraform shows how to create a new route table and associate it with subnets, but we can also use the main route table.

To access the default route table ID, use the following command:  
```bash
terraform state show aws_vpc.myapp-vpc
```

Before applying changes, use the following command to check what will be created or modified:  
```bash
terraform plan
```

Then apply the changes with:
```bash
terraform apply --auto-approve
```

### Security Group Configuration

The security group will have 2 rules:
- Open port 22 for SSH
- Open port 8080 for browser access

In the *Ingress* configuration, replace the CIDR block with your IP address, adding /32 so it applies to a single address only.
Your *my_ip* value can be found in the `terraform.tfvars` file.

**Note**: You can also use the default security group instead of creating a new one.
This can be done by using:
```bash
resource "aws_default_security_group" "default-sg" {
  # no name needed
}
```

For the EC2 instance, the AMI will be set dynamically since its ID can change.  

The owner of the image can be found in the AWS Management Console under **EC2 → Images → AMIs**.  
Select **Public Images** and paste the image ID in the search field to locate it.  
The image ID can also be found when adding a new EC2 instance.

### EC2 Key Pair Configuration

1. In the AWS Console, go to **EC2 → Key Pairs**.  
2. Click **Create Key Pair** with the following settings:  
   - **Name:** `server-key-pair`  
   - **Format:** `.pem`  

3. Move the `.pem` file to your `.ssh` folder:  
```bash
mv ~/Downloads/server-key-pair.pem ~/.ssh/
ls ~/.ssh/server-key-pair.pem
```

4. Restrict permissions on the .pem file:
```bash
chmod 400 ~/.ssh/server-key-pair.pem
ls -l ~/.ssh/server-key-pair.pem
```

> *Note:* This step is required to securely access your EC2 instance.

To SSH into your EC2 instance, use the following command:
```bash
ssh -i ~/.ssh/server-key-pair.pem ec2-user@<ec2-public-ip-address>
```

> Replace <ec2-public-ip-address> with the public IP of your EC2 instance.

### Automating Key Pair

To automate the key pair, you need to already have a key pair locally on your machine.  
If you already have one for a Git repository or a DigitalOcean Droplet, it can be found under `.ssh`:  
```bash
ls ~/.ssh/
```

> We will use the file: `id_ed25519.pub`. Update the variable inside terraform.tfvars with the location of `id_ed25519.pub`.

To SSH into the new server, use either of the following commands:
```bash
ssh -i ~/.ssh/id_ed25519 ec2-user@<public-ec2-ip-address>
# Or the shortcut
ssh ec2-user@<public-ec2-ip-address>
```

We will use the key pair that we created, so remove any manually created key pairs:
```bash
rm ~/.ssh/server-key-pair.pem
ls ~/.ssh  # to confirm it was deleted
```

> *Note:* Also, go to the AWS Console → Key Pairs and delete server-key-pair.

### Deploying Docker Container to EC2

Configure the Terraform script to automate deploying a Docker container to the EC2 instance.  

The deployment script is located in `entry-script.sh` and will be executed only once.  

1. Get the public IP address of the EC2 instance and SSH into it:
```bash
ssh ec2-user@<public-ip-address>
```

2. Check that Docker is running and the container is up:
```bash
docker ps
```

3. To verify that everything is working, open a browser and navigate to:
`http://<public-ip-address>:8080`

> You should see the **Welcome to nginx!** page.

